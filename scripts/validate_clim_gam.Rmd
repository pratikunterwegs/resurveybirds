---
editor_options: 
  chunk_output_type: console
---

# Validating semi-Spatial GAMs for climate

## Prepare weather and spatial data

```{r}
# for data
library(tidyverse)
library(sf)

# for gam
library(mgcv)

# for rasters
library(raster)
library(terra)
```

Load data prepared for the GAM, and the stack predictor raster.

```{r}
# read data
data = read_csv("data/output/data_for_gam.csv")
stack = raster::stack("data/output/raster_gam_stack.tif")
```

Prepare data covariates and raster.

```{r}
# trim data for distance to coast
data = mutate(
  data,
  coast = coast / 1000,
  coast = coast + rnorm(length(coast), 0.1, sd = 0.01),
  elev = elev + rnorm(length(coast), 1, sd = 0.01),
  lat = lat + rnorm(length(lat), 0, sd = 0.01)
)

# set distance to coast raster in km
values(stack[["coast"]]) = values(stack[["coast"]]) / 1000
```

Pivot longer to separate by variable.

```{r}
# pivot longer
data = pivot_longer(
    data,
    cols = c("ppt", "t_mean", "t_sd"),
    names_to = "climvar"
)
data = dplyr::select(data, !month)

# select period 1970 -- 2010
data = filter(data, between(year, 1970, 2010))
```

Split the data by variable.

```{r}
data = nest(
  data, data = !c(climvar, season, year_bin)
)
```

## Fit candidate models

Prepare model formulas.

```{r}
# elevation with 3 knots
form_elev_model = value ~ s(elev, k = 3)

# elevation and coast
form_elev_coast = value ~ s(elev, k = 3) + s(coast, k = 3)

# elevation and coast with lat
form_elev_colat = value ~ s(elev, k = 3) + s(coast, lat, k = 5)
```

```{r}
# make combinations
data = crossing(
  data, 
  forms = c(form_elev_model, form_elev_coast, form_elev_colat)
)
```

```{r}
# fit models
data = mutate(
  data,
  mod = map2(data, forms, function(df, form) {
    gam(
      formula = form,
      data = df
    )
  })
)
```

Save model data.

```{r}
save(data, file = "data/output/model_gam_climate.Rds")
```

## Predict over static environment

Get predictions

```{r}
# save model predictions
model_pred = map(
  data$mod, function(g) {
    predict(stack, g, type = "response") # order matters here
  }
)

save(model_pred, file = "data/output/model_pred_climate.Rds")
```

Average predictions over 1970 -- 2010.

```{r}
# assign as list column
data = mutate(
  data,
  pred = model_pred
)

# summarise using a reduce over the list
data_pred = ungroup(data) %>% 
  group_by(season, climvar, forms) %>% 
  summarise(
    mean_pred = list(Reduce(pred, f = mean))
  )

# save averaged predictions
save(
  data_pred,
  file = "data/output/model_pred_average.Rds"
)
```

## Get BIOCLIM data

```{r}
patterns <- c("tmin", "tmax")

# list the filepaths
tkAvg <- map(patterns, function(pattern) {
  # list the paths
  files <- list.files(
    path = "data/spatial/chelsa",
    full.names = TRUE,
    recursive = TRUE,
    pattern = pattern
  )
})

# now run over the paths and read as rasters and crop by buffer
tkAvg <- map(tkAvg, function(paths) {
  # going over the file paths, read them in as rasters, convert CRS and crop
  tempData <- map(paths, function(path) {
    # read in
    a <- terra::rast(path)
    # assign crs
    # terra::crs(a) <- "epsg:4326"
    # crop by buffer, will throw error if CRS doesn't match
    a <- terra::crop(a, terra::ext(stack))
    # return a
    a
  })
  # convert each to kelvin, first dividing by 10 to get celsius
  tempData <- map(tempData, function(tmpRaster) {
    terra::values(tmpRaster) <- terra::values(tmpRaster / 10) + 273.15
    tmpRaster
  })
})

# recursively get the mean temperature for each month
# assign names
names(tkAvg) <- patterns

# go over the tmin and tmax and get the average monthly temp
tkAvg <- map2(tkAvg[["tmin"]], tkAvg[["tmax"]], function(tmin, tmax) {
  # return the mean of the corresponding tmin and tmax
  # still in kelvin
  terra::mean(c(tmin, tmax))
})

# check temp data
assertthat::assert_that(
  length(tkAvg) == 12,
  msg = "temp raster list has fewer than 12 months"
)

# assign names
names(tkAvg) = sprintf("month_%i", seq(12))

# separate rainy and dry season
temp_rainy = Reduce(tkAvg[seq(6, 11)], f = `c`) |>
  terra::mean()
temp_dry = Reduce(tkAvg[c(12, seq(5))], f = `c`) |>
  terra::mean()

# convert values
chelsa_t_mean = c(temp_rainy, temp_dry) - 273.15
names(chelsa_t_mean) = c("chelsa_temp_rainy_6_11", "chelsa_temp_dry_12_5")

# save stack
terra::writeRaster(
  chelsa_t_mean,
  filename = "data/output/chelsa_temp_stack.tif"
)
```

